\section{Umsetzung}
\subsection{Technologie und Plattform}
In der Problembeschreibung zu dieser Arbeit wurden die Anforderungen an eine SmartHome Lösung diskutiert. In der anschliessenden Marktanalyse wurde openHAB als Grundlage zur Umsetzung unseres Projekts evaluiert. OpenHAB erfüllt die geforderten Kritierien, wie Herstellerunabhängigkeit, Installierbarkeit und Flexibilität. 
Für unser Projekt werden verschiedene Technologien bzw. Platformen eingesetzt. Auf der Clientseite, im SmartHome, wird openHAB mit verschiedenen Bindings eingesetzt. Cloudseitig wird MS Azure Cloud zur Persistierung von Events verwendet.

\subsection{openHAB}
Das System openHAB wird eingesetzt, um verschiedene Home-Automatisierungssysteme unter einen Hut zu bringen. Um dies zu realisieren bietet openHAB eine grosse Anzahl von Bindings mit, mit denen die verschiedenen Systeme angesprochen werden können.

\subsubsection{Module}
OpenHAB ist durch OSGi-Bundles modular aufgebaut und binhaltet folgende Komponenten:

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.45]{report/img/openHAB_architecture}
	\caption{openHAB Architektur}
	\label{fig:ohArch}
\end{figure}


\subsubsection{Kommunikation}
Der Basisservice von openHAB stellt der Event Bus. Über diesen Bus werden Events zwischen den verschiedenen Bundles gesendet. Die Events sind entweder Commands, welche eine Aktion ausführen, oder Status-Updates, welche Statusänderungen der Devices beinhaltet. \\
Durch den Einsatz dieses EventBus wird die Kopplung reduziert und können somit einfach ausgetauscht werden. \\
Für die Verwaltung der verschiedenen Status ist das Item Repository zuständig, welches permanent den Event Bus auf Status-Updates abhört und die Änderungen ins Repository schreibt. Falls auf einem GUI ein Status eines Devices angezeigt werden soll, kann dazu das Item Repository abgefragt werden.\\
Das Repository persistiert die Status und ist somit auch nach einem Neustart verfügbar.

\begin{figure}[H]
	\centering
		\includegraphics[scale=0.4]{report/img/communicationOH}
	\caption{Kommunikation openHAB}
	\label{fig:ohComm}
\end{figure}

\subsubsection{Bindings}
Ein Binding ist eine Verbindung zwischen dem Event Bus und den externen Systemen. Diese Verbindungen sind aufgrund der verschiedenen Technologien verschieden. Dadurch muss für jede Technologie ein eigenes Binding geschrieben werden. Für einige Systeme sind Bindings vorhanden, die einzeln heruntergeladen und als «Add-on» installiert werden können.
Die Bindings stellen nur sicher, dass Events zwischen Event Bus und den jeweiligen Devices ausgetauscht werden können. Sie müssen sich also nicht um Statusänderungen oder ähnliches kümmern, da dies durch das Item Repository übernommen wird. \\
Alle momentan verfügbare Bindings sind unter folgendem Link zu finden: \url{https://github.com/openhab/openhab/wiki/Bindings}

\pagebreak

\subsection{Installation openHAB}



\subsection{Deploymentübersicht}

\subsubsection{Binding Azure}
\begin{figure}[h!]
	\centering
		\includegraphics[scale=0.5]{report/img/deployment_binding_azure}
	\caption{Binding Azure Cloud}
	\label{fig:deploymentAzure}
\end{figure}

\subsubsection{MQTT Client}

\begin{lstlisting}[style=csharp, caption=MQTT Client in Worker Role]
	var stream = Assembly.GetExecutingAssembly()
					.GetManifestResourceStream("m2mqtt_ca.cer");
	var bytes = new byte[stream.Length];
	stream.Read(bytes, 0, bytes.Length);
	var cert = new X509Certificate2(bytes, "certPassword");

	MqttClient client = new MqttClient("greekinsWIN",
									8883,
									true,
									new X509Certificate(cert));
	client.Connect(Guid.NewGuid().ToString());

	for (int i = 0; i < 10; i++)
		client.Publish(
			"sensor/temp", Encoding.UTF8.GetBytes("27"),
			MqttMsgBase.QOS_LEVEL_AT_LEAST_ONCE, true
		);
	Console.Read();
\end{lstlisting}
